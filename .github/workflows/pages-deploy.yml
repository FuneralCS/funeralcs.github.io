name: Build and Deploy
on:
  push:
    branches:
      - main
      - master
    paths-ignore:
      - .gitignore
      - README.md
      - LICENSE
  workflow_dispatch:

permissions:
  contents: write
  pages: write
  id-token: write

# Sadece bir deployâ€™Ä±n aynÄ± anda Ã§alÄ±ÅŸmasÄ±nÄ± saÄŸlar
concurrency:
  group: "pages"
  cancel-in-progress: true

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Pages
        id: pages
        uses: actions/configure-pages@v4

      - name: Setup Ruby
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: 3.3
          bundler-cache: true

      - name: Build site
        run: bundle exec jekyll b -d "_site${{ steps.pages.outputs.base_path }}"
        env:
          JEKYLL_ENV: "production"

      - name: Test site
        run: |
          bundle exec htmlproofer _site \
          --disable-external \
          --ignore-urls "/^http:\/\/127\.0\.0\.1/,/^http:\/\/0\.0\.0\.0/,/^http:\/\/localhost/,/\/en\/$/"

      - name: Upload site artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: "_site${{ steps.pages.outputs.base_path }}"

  deploy:
    needs: build
    runs-on: ubuntu-latest
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}

    steps:
      # 1) Repoâ€™yu Ã§ekiyoruz ki hem deploy hem commit adÄ±mlarÄ± Ã§alÄ±ÅŸsÄ±n
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          persist-credentials: true

      # 2) Deploy adÄ±mÄ±
      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
      # fetch
      - name: Load notified_posts.json from notifications branch
        run: |
          # notifications branchâ€™ini fetch et
          git fetch origin notifications
          # EÄŸer dosya varsa al, yoksa boÅŸ bir JSON oluÅŸtur
          git checkout origin/notifications -- notified_posts.json 2>/dev/null || echo '[]' > notified_posts.json
          
      # 3) Feedâ€™i Ã§ek, yeni baÅŸlÄ±k varsa OneSignalâ€™a gÃ¶nder, sonra listeyi gÃ¼ncelle
      - name: Fetch feed & send OneSignal notification
        env:
          ONESIGNAL_APP_ID:        ${{ secrets.ONESIGNAL_APP_ID }}
          ONESIGNAL_REST_API_KEY:  ${{ secrets.ONESIGNAL_REST_API_KEY }}
        run: |
          python3 - <<'EOF'
          import os, json, sys, urllib.request
          from xml.etree import ElementTree as ET
          from urllib.error import HTTPError

          FEED_URL  = 'https://funeralcs.com/feed.xml'
          SEEN_FILE = 'notified_posts.json'

          # Secretsâ€™i al
          APP_ID   = os.environ['ONESIGNAL_APP_ID']
          REST_KEY = os.environ['ONESIGNAL_REST_API_KEY']

          # 1) Feedâ€™i Ã§ek ve parse et
          data = urllib.request.urlopen(FEED_URL).read()
          root = ET.fromstring(data)
          ns   = {'atom': 'http://www.w3.org/2005/Atom'}
          entries = root.findall('atom:entry', ns)
          if not entries:
              print('âš ï¸ Feed boÅŸ, Ã§Ä±kÄ±lÄ±yor.')
              sys.exit(0)

          latest = entries[0]
          title  = latest.find('atom:title', ns).text
          link   = latest.find('atom:link', ns).attrib['href']

          # 2) Daha Ã¶nce gÃ¶rÃ¼lenleri oku
          if os.path.exists(SEEN_FILE):
              seen = json.load(open(SEEN_FILE))
          else:
              seen = []

          if title in seen:
              print('ðŸ” Zaten bildirildi:', title)
              sys.exit(0)

          # 3) OneSignalâ€™a bildirim isteÄŸi yap
          payload = {
              "app_id": APP_ID,
              "included_segments": ["All"],
              "headings": {"en": title},
              "contents": {"en": "FuneralCSâ€™te yeni bir gÃ¶nderi yayÄ±nlandÄ±!"},
              "url": link
          }
          req = urllib.request.Request(
              "https://onesignal.com/api/v1/notifications",
              data=json.dumps(payload).encode('utf-8'),
              headers={
                  "Authorization": f"Basic {REST_KEY}",
                  "Content-Type": "application/json"
              }
          )
          try:
              resp = urllib.request.urlopen(req)
              print("âœ… Bildirim gÃ¶nderildi:", resp.status, resp.read().decode())
          except HTTPError as e:
              err = e.read().decode()
              print(f"âŒ OneSignal HatasÄ± {e.code}: {err}")
              sys.exit(1)

          # 4) GÃ¶rÃ¼lenler listesine ekle ve kaydet
          seen.append(title)
          with open(SEEN_FILE, 'w') as f:
              json.dump(seen, f)
          EOF

      # 4) EÄŸer notified_posts.json deÄŸiÅŸtiyse, notifications branchâ€™ine commit et
        # 4) EÄŸer notified_posts.json deÄŸiÅŸtiyse, notifications branchâ€™ine commit et
      - name: Commit notified list to `notifications` branch
        if: success()
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
    
          # 1) Remote notifications dalÄ±nÄ± Ã§ek (varsa)
          git fetch origin notifications || true
    
          # 2) Yeni dosyayÄ± gÃ¼vene al
          mv notified_posts.json /tmp/notified_posts.json
    
          # 3) notifications dalÄ±na geÃ§ (lokalde varsa direkt, yoksa originâ€™den Ã§ek)
          if git show-ref --verify --quiet refs/heads/notifications; then
            git checkout notifications
          elif git ls-remote --exit-code --heads origin notifications; then
            git checkout -b notifications origin/notifications
          else
            git checkout -b notifications
          fi
    
          # 4) GÃ¼ncellenmiÅŸ listeyi geri getir
          mv /tmp/notified_posts.json notified_posts.json
    
          # 5) Commit & push
          git add notified_posts.json
          if ! git diff --cached --quiet; then
            git commit -m "Update notified posts list"
            git push origin notifications
          else
            echo "âœ”ï¸ Bildirim listesi deÄŸiÅŸmemiÅŸ."
          fi
