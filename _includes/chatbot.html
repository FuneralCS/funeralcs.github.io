<script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

<style>
  /* --- BUTON VE PENCERE --- */
  #chat-trigger {
    position: fixed;
    bottom: 25px;
    right: 25px;
    width: 60px;
    height: 60px;
    background: #1a1a1a;
    border-radius: 50%;
    box-shadow: 0 4px 15px rgba(0,0,0,0.3);
    cursor: pointer;
    z-index: 9999;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: transform 0.3s ease, background 0.3s;
    border: 2px solid #333;
  }
  #chat-trigger:hover { transform: scale(1.1); background: #000; }
  #chat-trigger svg { width: 30px; height: 30px; fill: #fff; }

  #chat-window {
    display: none;
    position: fixed;
    bottom: 100px;
    right: 25px;
    width: 360px;
    height: 550px; /* Biraz daha uzun yaptÄ±m */
    background: #fff;
    border-radius: 16px;
    box-shadow: 0 10px 30px rgba(0,0,0,0.2);
    z-index: 9999;
    flex-direction: column;
    overflow: hidden;
    font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
    border: 1px solid #e0e0e0;
    animation: chatPop 0.3s cubic-bezier(0.18, 0.89, 0.32, 1.28);
  }

  @keyframes chatPop {
    0% { opacity: 0; transform: scale(0.9) translateY(20px); }
    100% { opacity: 1; transform: scale(1) translateY(0); }
  }

  /* --- BAÅžLIK --- */
  .chat-header {
    background: #1a1a1a;
    color: #fff;
    padding: 16px;
    font-weight: 600;
    display: flex;
    justify-content: space-between;
    align-items: center;
    border-bottom: 1px solid #333;
  }
  .chat-header-controls { display: flex; align-items: center; gap: 15px; }
  .clear-btn { font-size: 12px; color: #bbb; cursor: pointer; text-decoration: underline; }
  .clear-btn:hover { color: #fff; }
  .close-btn { cursor: pointer; font-size: 22px; line-height: 1; }

  /* --- MESAJ ALANI --- */
  #chat-messages {
    flex: 1;
    padding: 15px;
    overflow-y: auto;
    background: #f8f9fa;
    display: flex;
    flex-direction: column;
    gap: 12px;
  }

  /* --- BALONCUKLAR --- */
  .message {
    max-width: 85%;
    padding: 12px 16px;
    border-radius: 12px;
    font-size: 14px;
    line-height: 1.5;
    word-wrap: break-word;
    position: relative;
  }

  /* Bot MesajÄ± */
  .message.bot {
    background: #fff;
    border: 1px solid #e5e7eb;
    align-self: flex-start;
    border-bottom-left-radius: 4px;
    color: #374151;
    box-shadow: 0 1px 2px rgba(0,0,0,0.05);
  }

  /* Bot MesajÄ± Ä°Ã§indeki Markdown Stilleri */
  .message.bot strong { color: #000; font-weight: 700; }
  .message.bot a { color: #2563eb; text-decoration: none; font-weight: 500; }
  .message.bot a:hover { text-decoration: underline; }
  .message.bot ul, .message.bot ol { margin: 5px 0; padding-left: 20px; }
  .message.bot p { margin: 0 0 8px 0; }
  .message.bot p:last-child { margin-bottom: 0; }
  .message.bot code { background: #f3f4f6; padding: 2px 4px; border-radius: 4px; font-family: monospace; font-size: 12px; color: #e11d48; }
  .message.bot pre { background: #1f2937; color: #e5e7eb; padding: 10px; border-radius: 8px; overflow-x: auto; margin: 10px 0; }
  .message.bot pre code { background: transparent; color: inherit; padding: 0; }

  /* KullanÄ±cÄ± MesajÄ± */
  .message.user {
    background: #000;
    color: #fff;
    align-self: flex-end;
    border-bottom-right-radius: 4px;
  }

  /* --- INPUT ALANI --- */
  .chat-input-area {
    padding: 12px;
    border-top: 1px solid #eee;
    background: #fff;
    display: flex;
    gap: 8px;
    align-items: center;
  }
  .chat-input-area input {
    flex: 1;
    padding: 12px 15px;
    border: 1px solid #ddd;
    border-radius: 25px;
    outline: none;
    font-size: 14px;
    transition: border-color 0.2s;
  }
  .chat-input-area input:focus { border-color: #666; }

  .chat-input-area button {
    background: #000;
    color: #fff;
    border: none;
    width: 40px;
    height: 40px;
    border-radius: 50%;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: background 0.2s;
  }
  .chat-input-area button:hover { background: #333; }
  .chat-input-area button:disabled { background: #ccc; cursor: not-allowed; }
  .chat-input-area button svg { width: 18px; height: 18px; fill: #fff; margin-left: 2px; }

  .typing-indicator {
    font-size: 12px; color: #666;
    margin: 0 0 10px 15px;
    display: none;
    font-style: italic;
  }
  .message.bot::after {
    content: '';
    display: inline-block;
    width: 2px;
    height: 12px;
    background: #333;
    animation: blink 1s infinite;
    vertical-align: middle;
    display: none; /* Sadece yazarken gÃ¶rÃ¼nÃ¼r yapacaÄŸÄ±z */
  }
  .message.bot.typing::after { display: inline-block; }
  @keyframes blink { 0%, 100% { opacity: 1; } 50% { opacity: 0; } }
</style>

<div id="chat-trigger" onclick="toggleChat()">
  <svg viewBox="0 0 24 24"><path d="M20 2H4c-1.1 0-2 .9-2 2v18l4-4h14c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2z"/></svg>
</div>

<div id="chat-window">
  <div class="chat-header">
    <span>FuneralCS Asistan ðŸ¤–</span>
    <div class="chat-header-controls">
      <span class="clear-btn" onclick="clearChat()">Temizle</span>
      <span class="close-btn" onclick="toggleChat()">Ã—</span>
    </div>
  </div>
  <div id="chat-messages"></div>
  <div class="chat-input-area">
    <input type="text" id="user-input" placeholder="Sorunu yaz..." onkeypress="handleKeyPress(event)">
    <button id="send-btn" onclick="sendMessage()"><svg viewBox="0 0 24 24"><path d="M2.01 21L23 12 2.01 3 2 10l15 2-15 2z"/></svg></button>
  </div>
</div>

<script>
  const WORKER_URL = "https://funeralcs-bot.funeralcsblog.workers.dev";
  let chatHistory = [];

  document.addEventListener('DOMContentLoaded', loadHistory);

  function toggleChat() {
    const win = document.getElementById('chat-window');
    const isHidden = win.style.display === 'none' || win.style.display === '';
    win.style.display = isHidden ? 'flex' : 'none';
    if(isHidden) { document.getElementById('user-input').focus(); scrollToBottom(); }
  }

  function handleKeyPress(e) { if (e.key === 'Enter') sendMessage(); }

  function clearChat() {
    localStorage.removeItem('funeralcs_chat_history');
    chatHistory = [];
    document.getElementById('chat-messages').innerHTML = '';
    addMessageToUI("**Sohbet temizlendi.** Merhaba! ðŸ‘‹", 'bot');
  }

  function loadHistory() {
    const saved = localStorage.getItem('funeralcs_chat_history');
    if (saved) {
      chatHistory = JSON.parse(saved);
      chatHistory.forEach(msg => addMessageToUI(msg.content, msg.role === 'user' ? 'user' : 'bot'));
    } else {
      addMessageToUI("**Selam!** ðŸ‘‹ FuneralCS blog asistanÄ±yÄ±m.", 'bot');
    }
  }

  // --- STREAMING SEND MESSAGE ---
  async function sendMessage() {
    const input = document.getElementById('user-input');
    const question = input.value.trim();
    if (!question) return;

    addMessageToUI(question, 'user');
    input.value = '';
    chatHistory.push({ role: 'user', content: question });
    saveHistory();

    const sendBtn = document.getElementById('send-btn');
    input.disabled = true;
    sendBtn.disabled = true;

    // Bot mesajÄ± iÃ§in boÅŸ bir baloncuk oluÅŸturuyoruz
    const botMessageDiv = addMessageToUI("", 'bot', true); // true: "typing" class ekle
    let fullResponse = "";

    try {
      const response = await fetch(WORKER_URL, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ question: question, history: chatHistory })
      });

      // --- AKIÅžI OKUMA (STREAM READER) ---
      const reader = response.body.getReader();
      const decoder = new TextDecoder();

      while (true) {
        const { done, value } = await reader.read();
        if (done) break;

        // Gelen veriyi (chunk) Ã§Ã¶z
        const chunk = decoder.decode(value, { stream: true });

        // Cloudflare veriyi "data: {...}" formatÄ±nda gÃ¶nderir. Bunu ayÄ±klamalÄ±yÄ±z.
        // Bazen birden fazla satÄ±r gelebilir.
        const lines = chunk.split('\n');

        for (const line of lines) {
          if (line.startsWith('data: ')) {
            const jsonStr = line.slice(6); // "data: " kÄ±smÄ±nÄ± at
            if (jsonStr.trim() === '[DONE]') continue; // BitiÅŸ sinyali

            try {
              const data = JSON.parse(jsonStr);
              if (data.response) {
                fullResponse += data.response;
                // AnlÄ±k olarak ekrana bas (Markdown renderlayarak)
                botMessageDiv.innerHTML = marked.parse(fullResponse);
                scrollToBottom();
              }
            } catch (e) { console.error("JSON Parse HatasÄ±:", e); }
          }
        }
      }

      // BittiÄŸinde
      botMessageDiv.classList.remove('typing'); // Ä°mleci kaldÄ±r
      chatHistory.push({ role: 'assistant', content: fullResponse });
      saveHistory();

    } catch (error) {
      botMessageDiv.innerHTML = `âš ï¸ **Hata:** ${error.message}`;
      botMessageDiv.classList.remove('typing');
    } finally {
      input.disabled = false;
      sendBtn.disabled = false;
      input.focus();
    }
  }

  function addMessageToUI(text, sender, isTyping = false) {
    const messages = document.getElementById('chat-messages');
    const msgDiv = document.createElement('div');
    msgDiv.classList.add('message', sender);
    if (isTyping) msgDiv.classList.add('typing');

    if (sender === 'bot') {
      msgDiv.innerHTML = marked.parse(text);
    } else {
      msgDiv.textContent = text;
    }

    messages.appendChild(msgDiv);
    scrollToBottom();
    return msgDiv; // Div'i geri dÃ¶ndÃ¼r ki streaming ile iÃ§ini dolduralÄ±m
  }

  function scrollToBottom() {
    const messages = document.getElementById('chat-messages');
    messages.scrollTop = messages.scrollHeight;
  }

  function saveHistory() {
    if(chatHistory.length > 50) chatHistory = chatHistory.slice(-50);
    localStorage.setItem('funeralcs_chat_history', JSON.stringify(chatHistory));
  }
</script>
